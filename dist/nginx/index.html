<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nginx | Simon&#39;s Blog</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/blog-src/dist/assets/css/styles.2c447bbf.css" as="style"><link rel="preload" href="/blog-src/dist/assets/js/app.2c447bbf.js" as="script"><link rel="preload" href="/blog-src/dist/assets/js/18.bc91cc83.js" as="script"><link rel="prefetch" href="/blog-src/dist/assets/css/3.styles.6d42e6eb.css"><link rel="prefetch" href="/blog-src/dist/assets/css/7.styles.d8aa6043.css"><link rel="prefetch" href="/blog-src/dist/assets/js/1.346d1771.js"><link rel="prefetch" href="/blog-src/dist/assets/js/10.363c8a45.js"><link rel="prefetch" href="/blog-src/dist/assets/js/11.5baa2a3d.js"><link rel="prefetch" href="/blog-src/dist/assets/js/12.344ec3f7.js"><link rel="prefetch" href="/blog-src/dist/assets/js/13.9fa7751f.js"><link rel="prefetch" href="/blog-src/dist/assets/js/14.40547c82.js"><link rel="prefetch" href="/blog-src/dist/assets/js/15.b2b95d06.js"><link rel="prefetch" href="/blog-src/dist/assets/js/16.4c8ccfef.js"><link rel="prefetch" href="/blog-src/dist/assets/js/17.68ef0347.js"><link rel="prefetch" href="/blog-src/dist/assets/js/19.f741de0f.js"><link rel="prefetch" href="/blog-src/dist/assets/js/2.11100d72.js"><link rel="prefetch" href="/blog-src/dist/assets/js/20.772a3934.js"><link rel="prefetch" href="/blog-src/dist/assets/js/21.d0df2139.js"><link rel="prefetch" href="/blog-src/dist/assets/js/22.349c1903.js"><link rel="prefetch" href="/blog-src/dist/assets/js/3.6d42e6eb.js"><link rel="prefetch" href="/blog-src/dist/assets/js/4.336b6ab2.js"><link rel="prefetch" href="/blog-src/dist/assets/js/5.13d5ad22.js"><link rel="prefetch" href="/blog-src/dist/assets/js/6.211be650.js"><link rel="prefetch" href="/blog-src/dist/assets/js/7.d8aa6043.js"><link rel="prefetch" href="/blog-src/dist/assets/js/8.721020a7.js"><link rel="prefetch" href="/blog-src/dist/assets/js/9.3674cdea.js">
    <link rel="stylesheet" href="/blog-src/dist/assets/css/3.styles.6d42e6eb.css"><link rel="stylesheet" href="/blog-src/dist/assets/css/7.styles.d8aa6043.css"><link rel="stylesheet" href="/blog-src/dist/assets/css/styles.2c447bbf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog-src/dist/" class="home-link router-link-active"><!----> <span class="site-name">Simon's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/js/" class="nav-link">js</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/elasticsearch/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/nginx/" class="nav-link router-link-exact-active router-link-active">nginx</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/swoole/" class="nav-link">swoole</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/live/" class="nav-link">直播入门</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/js/" class="nav-link">js</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/elasticsearch/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/nginx/" class="nav-link router-link-exact-active router-link-active">nginx</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/swoole/" class="nav-link">swoole</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/live/" class="nav-link">直播入门</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog-src/dist/nginx/" class="active sidebar-link">nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-src/dist/nginx/#nginx简介" class="sidebar-link">nginx简介</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/nginx/#nginx的发行版本选择" class="sidebar-link">nginx的发行版本选择</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/nginx/#nginx的编译安装" class="sidebar-link">nginx的编译安装</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/nginx/#nginx命令行的使用" class="sidebar-link">nginx命令行的使用</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/nginx/#静态服务器的一些重要配置" class="sidebar-link">静态服务器的一些重要配置</a></li></ul></li><li><a href="/blog-src/dist/nginx/architecture.html" class="sidebar-link">nginx的架构</a></li><li><a href="/blog-src/dist/nginx/http.html" class="sidebar-link">http模块详解</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="nginx"><a href="#nginx" aria-hidden="true" class="header-anchor">#</a> nginx</h1> <h2 id="nginx简介"><a href="#nginx简介" aria-hidden="true" class="header-anchor">#</a> nginx简介</h2> <p>维基百科nginx的介绍：</p> <blockquote><p>nginx是一个web server(web服务器)，也可用于反向代理、负载均衡、邮件代理、HTTP缓存。该软件由Igor Sysoev创建，于2004年公开发布。</p></blockquote> <h3 id="nginx产生原因"><a href="#nginx产生原因" aria-hidden="true" class="header-anchor">#</a> nginx产生原因</h3> <p>原因主要有以下三点：</p> <ol><li>由于互联网的普及、全球化和物联网等，导致互联网的数据量快速增长</li> <li>服务器的硬件由单核CPU向多核的转变</li> <li>低效的apache（也是一个web服务器）</li></ol> <p>由于上面这些原因，nginx解决了以下两个问题</p> <ol><li>处理高并发、并且保持高性能</li> <li>nginx的架构是基于多核CPU的，能充分利用系统资源</li></ol> <h3 id="nginx主要优点"><a href="#nginx主要优点" aria-hidden="true" class="header-anchor">#</a> nginx主要优点</h3> <ol><li>高并发、高性能</li> <li>可扩展性好：这一点主要取决于它的模块化设计</li> <li>高可靠性：能在服务器稳定运行数年而不需要重启</li> <li>热部署：可以在不停止nginx服务的情况下，升级nginx版本</li> <li>开源协议使用的是BSD许可证：BSD许可证让nginx源代码开源免费，并且可以根据自身需求修改源代码用于商业环境</li></ol> <h3 id="nginx四个重要的组成部分"><a href="#nginx四个重要的组成部分" aria-hidden="true" class="header-anchor">#</a> nginx四个重要的组成部分</h3> <ol><li>二进制可执行文件：服务器启动是通过这个文件</li> <li>配置文件nginx.conf：配置文件控制着ngixn的行为</li> <li>访问日志access.log：记录每个http请求的访问记录</li> <li>错误日志error.log：当请求异常时会将错误信息写入错误日志，便于排查问题</li></ol> <h2 id="nginx的发行版本选择"><a href="#nginx的发行版本选择" aria-hidden="true" class="header-anchor">#</a> nginx的发行版本选择</h2> <ol><li><a href="http://nginx.org/" target="_blank" rel="noopener noreferrer">开源版nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：开源免费</li> <li><a href="https://www.nginx.com/" target="_blank" rel="noopener noreferrer">商业版nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：由nginx作者成立的商业公司管理，不开源，使用需要收费</li> <li><a href="http://tengine.taobao.org/" target="_blank" rel="noopener noreferrer">Tengine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：由淘宝网发起的一个web服务器开源项目，基于nginx基础上，添加了很多高级功能和特性.Tengine修改了nginx的主干代码，也就不会随着官方的Nginx版本走</li> <li><a href="https://openresty.org/cn/" target="_blank" rel="noopener noreferrer">开源版OpenResty<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：OpenResty® 是一个基于 Nginx 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</li> <li><a href="https://openresty.com/cn/" target="_blank" rel="noopener noreferrer">商业版OpenResty<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <p>选择建议：
没有复杂的业务诉求情况下，使用1即可，涉及复杂的业务诉求可以选择4</p> <hr> <h2 id="nginx的编译安装"><a href="#nginx的编译安装" aria-hidden="true" class="header-anchor">#</a> nginx的编译安装</h2> <p>除了编译安装，还可以通过工具来安装，如yum(linux)、brew（macOS），这种方式安装起来都便捷，而编译安装很大的好处就是可以自己指定需要安装那些模块</p> <p>接下来需要下载nginx的源码包，<a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，也可以是使用curl命令下载文件，生产环境建议使用stable版本，学习用可以使用最新的版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> -O http://nginx.org/download/nginx-1.15.8.tar.gz
<span class="token function">tar</span> -zxvf nginx-1.15.8.tar.gz
</code></pre></div><p>进入到解压后的目录，执行配置命令</p> <div class="language- extra-class"><pre class="language-text"><code>./configure --help
</code></pre></div><p>上面命令查看可以使用哪些参数，这些参数大概可以分为三类</p> <ol><li>安装路径设置，一般设置一个<code>--prefix=PATH</code>即可，其它目录会相对这个目录生成对应的目录，需要特殊指定的用参数来设置</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>  --prefix<span class="token operator">=</span>PATH                      <span class="token keyword">set</span> installation prefix
  --sbin-path<span class="token operator">=</span>PATH                   <span class="token keyword">set</span> nginx binary pathname
  --modules-path<span class="token operator">=</span>PATH                <span class="token keyword">set</span> modules path
  --conf-path<span class="token operator">=</span>PATH                   <span class="token keyword">set</span> nginx.conf pathname
  --error-log-path<span class="token operator">=</span>PATH              <span class="token keyword">set</span> error log pathname
  --pid-path<span class="token operator">=</span>PATH                    <span class="token keyword">set</span> nginx.pid pathname
  --lock-path<span class="token operator">=</span>PATH                   <span class="token keyword">set</span> nginx.lock pathname
</code></pre></div><ol start="2"><li>确定使用哪些模块和不使用哪些模块</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 这种前缀的通常表示默认不安装，需要安转就要使用参数指定</span>
--with-
<span class="token comment"># 这种前缀的通常默认都会安转，不需要安装也要用参数指定</span>
--without-
</code></pre></div><ol start="3"><li>一些杂项参数的设置，具体看文档描述即可</li></ol> <p>接下来进行编译前的配置，指定一个安装目录（macOS系统做测试），命令行执行完成如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>./configure --prefix<span class="token operator">=</span>/Users/simon/Code/nginx
<span class="token punctuation">..</span>.
Configuration summary
  + using system PCRE library
  + OpenSSL library is not used
  + using system zlib library

  nginx path prefix: <span class="token string">&quot;/Users/simon/Code/nginx&quot;</span>
  nginx binary file: <span class="token string">&quot;/Users/simon/Code/nginx/sbin/nginx&quot;</span>
  nginx modules path: <span class="token string">&quot;/Users/simon/Code/nginx/modules&quot;</span>
  nginx configuration prefix: <span class="token string">&quot;/Users/simon/Code/nginx/conf&quot;</span>
  nginx configuration file: <span class="token string">&quot;/Users/simon/Code/nginx/conf/nginx.conf&quot;</span>
  nginx pid file: <span class="token string">&quot;/Users/simon/Code/nginx/logs/nginx.pid&quot;</span>
  nginx error log file: <span class="token string">&quot;/Users/simon/Code/nginx/logs/error.log&quot;</span>
  nginx http access log file: <span class="token string">&quot;/Users/simon/Code/nginx/logs/access.log&quot;</span>
  nginx http client request body temporary files: <span class="token string">&quot;client_body_temp&quot;</span>
  nginx http proxy temporary files: <span class="token string">&quot;proxy_temp&quot;</span>
  nginx http fastcgi temporary files: <span class="token string">&quot;fastcgi_temp&quot;</span>
  nginx http uwsgi temporary files: <span class="token string">&quot;uwsgi_temp&quot;</span>
  nginx http scgi temporary files: <span class="token string">&quot;scgi_temp&quot;</span>
</code></pre></div><p>配置之后会生成中间文件目录<code>objs</code>，该目录有个<code>ngx_modules.c</code>，该文件记录了哪些模块会编译进来</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 编译并安装</span>
<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span>
</code></pre></div><p>进入之前指定的<code>--prefix</code>目录，启动文件在sbin目录</p> <div class="language-bash extra-class"><pre class="language-bash"><code>sbin/nginx
</code></pre></div><p>在浏览器访问<code>http://localhost</code>即可看到默认的nginx欢迎页面</p> <h3 id="nginx配置文件的通用语法介绍"><a href="#nginx配置文件的通用语法介绍" aria-hidden="true" class="header-anchor">#</a> nginx配置文件的通用语法介绍</h3> <p>nginx的配置文件有以下语法规则</p> <ol><li>指令和指令块组成，每条指令以<code>；</code>分号结尾</li> <li>指令与参数间以空格符号分割</li> <li>指令块以<code>{}</code>（大括号）将多条指令组织在一起</li> <li>include语句允许组合多个配置文件以提升可维护性</li> <li>使用<code>#</code>符号添加注释，提升可读性</li> <li>使用<code>$</code>符号就可以使用一个变量</li> <li>部分指令的参数支持正则表达式</li></ol> <p>nginx的结构设计是模块化的，一个指令块是由对应的nginx模块去解析并处理的</p> <p>这里以http指令块来作例子</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span>       mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>

    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
        <span class="token keyword">root</span> 	     <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token operator">/</span>default<span class="token punctuation">;</span>
        <span class="token keyword">access_log</span>   <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>default<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm <span class="token keyword">index</span><span class="token punctuation">.</span>php<span class="token punctuation">;</span>
            <span class="token keyword">autoindex</span>   on<span class="token punctuation">;</span>
            <span class="token keyword">include</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>fastcgi<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
            <span class="token keyword">fastcgi_intercept_errors</span> on<span class="token punctuation">;</span>
            <span class="token keyword">fastcgi_pass</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">location</span> <span class="token operator">/</span>hls<span class="token punctuation">{</span>
            <span class="token keyword">types</span><span class="token punctuation">{</span>
                application<span class="token operator">/</span>vnd<span class="token punctuation">.</span>apple<span class="token punctuation">.</span>mpegurl m3u8<span class="token punctuation">;</span>
                video<span class="token operator">/</span>mp2t ts<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">root</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>var<span class="token operator">/</span>www<span class="token punctuation">;</span>
            <span class="token keyword">add_header</span> Cache<span class="token operator">-</span>Control no<span class="token operator">-</span>cache<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">error_page</span>  <span class="token number">404</span>     <span class="token operator">/</span><span class="token number">404.</span>html<span class="token punctuation">;</span>
    <span class="token keyword">error_page</span>  <span class="token number">403</span>     <span class="token operator">/</span><span class="token number">403.</span>html<span class="token punctuation">;</span>

    <span class="token keyword">include</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>servers<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>http指令块主要有以下几部分组成</p> <ol><li>http</li> <li>server：一个server对应一个或者一组域名服务，设置的域名的时候可以设置多个域名都通过这个server来处理</li> <li>upstream：上游服务，当需要与其它服务交互可以使用到upstrem</li> <li>location：location表示一个url表达式</li></ol> <h3 id="配置参数的常用单位"><a href="#配置参数的常用单位" aria-hidden="true" class="header-anchor">#</a> 配置参数的常用单位</h3> <p>时间单位有八种</p> <ol><li>ms（milliseconds）：毫秒</li> <li>s（seconds）：秒</li> <li>m（minutes）：分钟</li> <li>h（hours）：小时</li> <li>d（days）:天</li> <li>w（weeks）：周</li> <li>M（months）：月，以30天计算</li> <li>y（years）：年，以365天计算</li></ol> <p>空间单位有四种</p> <ol><li>留空：表示字节（bytes）</li> <li>k/K：千字节（kilobytes）</li> <li>m/M：兆字节（megabytes）</li> <li>g/G：吉字节（gigabytes）</li></ol> <h2 id="nginx命令行的使用"><a href="#nginx命令行的使用" aria-hidden="true" class="header-anchor">#</a> nginx命令行的使用</h2> <p>安转好后使用命令长查看命令帮助</p> <div class="language-bash extra-class"><pre class="language-bash"><code>nginx -h
<span class="token comment"># 或者 nginx -?</span>
<span class="token comment"># 得到如下信息</span>
nginx version: nginx/1.15.7
Usage: nginx <span class="token punctuation">[</span>-?hvVtTq<span class="token punctuation">]</span> <span class="token punctuation">[</span>-s signal<span class="token punctuation">]</span> <span class="token punctuation">[</span>-c filename<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p prefix<span class="token punctuation">]</span> <span class="token punctuation">[</span>-g directives<span class="token punctuation">]</span>

Options:
  -?,-h         <span class="token keyword">:</span> this <span class="token function">help</span>
  -v            <span class="token keyword">:</span> show version and <span class="token keyword">exit</span>
  -V            <span class="token keyword">:</span> show version and configure options <span class="token keyword">then</span> <span class="token keyword">exit</span>
  -t            <span class="token keyword">:</span> <span class="token function">test</span> configuration and <span class="token keyword">exit</span>
  -T            <span class="token keyword">:</span> <span class="token function">test</span> configuration, dump it and <span class="token keyword">exit</span>
  -q            <span class="token keyword">:</span> suppress non-error messages during configuration testing
  -s signal     <span class="token keyword">:</span> send signal to a master process: stop, quit, reopen, reload
  -p prefix     <span class="token keyword">:</span> <span class="token keyword">set</span> prefix path <span class="token punctuation">(</span>default: /usr/local/Cellar/nginx-full/1.15.7/<span class="token punctuation">)</span>
  -c filename   <span class="token keyword">:</span> <span class="token keyword">set</span> configuration <span class="token function">file</span> <span class="token punctuation">(</span>default: /usr/local/etc/nginx/nginx.conf<span class="token punctuation">)</span>
  -g directives <span class="token keyword">:</span> <span class="token keyword">set</span> global directives out of configuration <span class="token function">file</span>
</code></pre></div><ol><li>-v，-V：打印出版本信息，-V会打印出编译安装时候的configure选项</li> <li>-t，-T：会检测配置文件是否存在语法问题并打印出问题信息，常用于服务修改后上线前的测试</li> <li>-s：这个会给nginx主进程一个信号，有以下4种</li></ol> <ul><li>stop：立刻停止服务</li> <li>quit：优雅的停止服务，处理正在进行的请求，新的请求将会直接拒绝，等到处理完所有请求就会停止服务</li> <li>reload：这个在不停止对外服务的情况下重新载入配置文件</li> <li>reopen：当需要换一个日志文件来记录日志时，可以使用这个信号</li></ul> <ol start="4"><li>-c：指定启动的配置文件来启动，不使用默认的配置文件</li> <li>-p：指定运行目录</li></ol> <h3 id="nginx版本热更新和日志切割"><a href="#nginx版本热更新和日志切割" aria-hidden="true" class="header-anchor">#</a> nginx版本热更新和日志切割</h3> <p>大致原理：</p> <p>通过直接替换<code>sbin</code>目录下面的<code>nginx</code>二进制可执行文件，替换前需要先备份一下之前的二进制文件；给master进程通过<code>kill</code>命令发送一个<code>-USR2</code>信号，就会使用之前复制的二进制文件启动一个nginx服务，
两个nginx服务是并存的，但是旧的nginx服务中的worker进程是不会监听80和443端口的，之后给旧的nginx的master进程使用<code>kill</code>命令发送一个<code>-WINCH</code>信号，旧的worker进程就会被关闭，旧master进程会继续运行，当新版本存在问题时，让旧的master进程重新创建worker进程</p> <p>nginx服务启动之后会生成两个进程一个master和一个worker进程，使用命令行查看</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">ps</span> aux <span class="token operator">|</span> <span class="token function">grep</span> nginx
<span class="token comment"># 这里省略调 grep 命令产生的进程</span>
simon 75728 0.0 0.0 4296252  1304  ??  S  9:31PM  0:00.00 nginx: worker process
simon 75727 0.0 0.0 4296016  516   ??  Ss 9:31PM  0:00.00 nginx: master process sbin/nginx
<span class="token comment"># 75728 为worker进程id</span>
<span class="token comment"># 75727 为master进程id</span>
</code></pre></div><p>日志切割原理：</p> <p>先将日志使用<code>mv</code>进行备份（cp命令会造成部分日志丢失问题，而mv不会），在通过执行<code>nginx -s reopen</code>就会新生成日志文件</p> <h2 id="静态服务器的一些重要配置"><a href="#静态服务器的一些重要配置" aria-hidden="true" class="header-anchor">#</a> 静态服务器的一些重要配置</h2> <p>nginx.conf配置文件如下</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 设置worker的进程个数</span>
<span class="token keyword">worker_processes</span>  <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">events</span> <span class="token punctuation">{</span>
    <span class="token comment"># worker进程允许的最大连接数</span>
    <span class="token keyword">worker_connections</span>  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token keyword">include</span>       mime<span class="token punctuation">.</span><span class="token keyword">types</span><span class="token punctuation">;</span>
    <span class="token keyword">default_type</span>  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    <span class="token comment">#log_format  main  '$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
    <span class="token comment">#                  '$status $body_bytes_sent &quot;$http_referer&quot; '</span>
    <span class="token comment">#                  '&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;';</span>
    <span class="token comment">#access_log  logs/access.log  main;</span>
    <span class="token keyword">sendfile</span>        on<span class="token punctuation">;</span>
    <span class="token comment">#tcp_nopush     on;</span>
    <span class="token comment">#keepalive_timeout  0;</span>
    <span class="token keyword">keepalive_timeout</span>  <span class="token number">65</span><span class="token punctuation">;</span>
    <span class="token comment">#gzip  on;</span>
    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span>  localhost<span class="token punctuation">;</span>
        <span class="token comment">#charset koi8-r;</span>
        <span class="token comment">#access_log  logs/host.access.log  main;</span>
        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>
            <span class="token keyword">root</span>   html<span class="token punctuation">;</span>
            <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>server中几个重要的设置项</p> <ol><li>listen：监听的端口号</li> <li>server_name：域名</li> <li>root：静态资源的根目录，也可以使用alias
root和alias使用上有差别，主要有以下几点</li></ol> <ul><li>alias只能在location中使用，root可以在http、server、location中使用</li> <li>alias指定当前location的访问根路径，</li></ul> <ol start="4"><li>gzip：为了让静态资源文件在网络中传输更快，需要使用这个指令</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># gzip是设置在http指令块里面的</span>
<span class="token comment"># 开启gzip</span>
<span class="token keyword">gzip</span> on<span class="token punctuation">;</span>
<span class="token comment"># 设置需要压缩文件的最小值，无单位默认是字节（Bytes），也可使用其它单位</span>
<span class="token comment"># 压缩是需要消耗服务器CPU资源的，所以压缩最小值设置不能过小，设置很小的值只是为了测试效果</span>
<span class="token keyword">gzip_min_length</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment"># 设置文件压缩等级</span>
<span class="token keyword">gzip_comp_level</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token comment"># 设置那些类型的文件需要压缩</span>
<span class="token keyword">gzip</span> <span class="token keyword">types</span> text<span class="token operator">/</span>plain text<span class="token operator">/</span>css text<span class="token operator">/</span>javascript application<span class="token operator">/</span>xml image<span class="token operator">/</span>gif<span class="token punctuation">;</span>
</code></pre></div><ol start="5"><li>autoindex: 当根目录或者根目录下某个子目录需要以一个列表的形式展现的时候可以，使用这个指令</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 这个指令在location指令块中</span>
<span class="token keyword">autoindex</span> on<span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>set $limit_rate：设置资源的传输速度；在服务器带宽有限的情况下，当用户访问某些大资源文件的时候，不设置传输速度的话，会影响其它用户或其它资源的访问，这个值设置在location中</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 可以给某些大资源文件放在一个目录，通过一个location去限制一下他的传输速度</span>
<span class="token comment"># set 也可设置其它东西，具体需要去nginx官网查看提供了哪些变量可以设置</span>
<span class="token keyword">set</span> <span class="token variable">$limit_rate</span> <span class="token number">1</span>k<span class="token punctuation">;</span>
</code></pre></div><ol start="7"><li>log_format：定义日志的格式，在http指令块中使用，可以存在多个log_format用于针对不同场景写不同的日志</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># main 表示这种日志格式的名字，后面的变量表示日志的格式，具体有哪些变量可供使用需要查看官方文档</span>
<span class="token keyword">log_format</span>  main  <span class="token string">'$remote_addr - $remote_user [$time_local] &quot;$request&quot; '</span>
                     <span class="token string">'$status $body_bytes_sent &quot;$http_referer&quot; '</span>
                     <span class="token string">'&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;'</span><span class="token punctuation">;</span>
</code></pre></div><ol start="8"><li>access_log和error_log：设置访问日志和错误日志，可以在server和location指令块中使用，写在不同的指令块中，决定了请求如何写日志</li></ol> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># 通过之前给log_format设置名字，在这里就可以使用了</span>
<span class="token keyword">access_log</span> logs<span class="token operator">/</span>access<span class="token punctuation">.</span>log main<span class="token punctuation">;</span>
<span class="token keyword">error_log</span> logs<span class="token operator">/</span>error<span class="token punctuation">.</span>log error<span class="token punctuation">;</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog-src/dist/nginx/architecture.html">
          nginx的架构
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog-src/dist/assets/js/18.bc91cc83.js" defer></script><script src="/blog-src/dist/assets/js/app.2c447bbf.js" defer></script>
  </body>
</html>
