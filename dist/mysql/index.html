<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mysql | Simon&#39;s Blog</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/blog-src/dist/assets/css/styles.2dbcb048.css" as="style"><link rel="preload" href="/blog-src/dist/assets/js/app.2dbcb048.js" as="script"><link rel="preload" href="/blog-src/dist/assets/js/6.deed1cda.js" as="script"><link rel="prefetch" href="/blog-src/dist/assets/css/3.styles.6d42e6eb.css"><link rel="prefetch" href="/blog-src/dist/assets/css/7.styles.d8aa6043.css"><link rel="prefetch" href="/blog-src/dist/assets/js/1.ef6d7d82.js"><link rel="prefetch" href="/blog-src/dist/assets/js/10.cac893df.js"><link rel="prefetch" href="/blog-src/dist/assets/js/11.b4626fbc.js"><link rel="prefetch" href="/blog-src/dist/assets/js/12.d99d2c43.js"><link rel="prefetch" href="/blog-src/dist/assets/js/13.2381fb66.js"><link rel="prefetch" href="/blog-src/dist/assets/js/14.6d193fd5.js"><link rel="prefetch" href="/blog-src/dist/assets/js/15.5b7fb46a.js"><link rel="prefetch" href="/blog-src/dist/assets/js/16.a403d1c9.js"><link rel="prefetch" href="/blog-src/dist/assets/js/17.b8a3de27.js"><link rel="prefetch" href="/blog-src/dist/assets/js/18.a034bb59.js"><link rel="prefetch" href="/blog-src/dist/assets/js/19.ca46936d.js"><link rel="prefetch" href="/blog-src/dist/assets/js/2.f20ba5be.js"><link rel="prefetch" href="/blog-src/dist/assets/js/20.ed0a211c.js"><link rel="prefetch" href="/blog-src/dist/assets/js/3.6d42e6eb.js"><link rel="prefetch" href="/blog-src/dist/assets/js/4.32ab6617.js"><link rel="prefetch" href="/blog-src/dist/assets/js/5.96e052de.js"><link rel="prefetch" href="/blog-src/dist/assets/js/7.d8aa6043.js"><link rel="prefetch" href="/blog-src/dist/assets/js/8.a718645b.js"><link rel="prefetch" href="/blog-src/dist/assets/js/9.91e3b67c.js">
    <link rel="stylesheet" href="/blog-src/dist/assets/css/3.styles.6d42e6eb.css"><link rel="stylesheet" href="/blog-src/dist/assets/css/7.styles.d8aa6043.css"><link rel="stylesheet" href="/blog-src/dist/assets/css/styles.2dbcb048.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog-src/dist/" class="home-link router-link-active"><!----> <span class="site-name">Simon's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/js/" class="nav-link">js</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/mysql/" class="nav-link router-link-exact-active router-link-active">mysql</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/elasticsearch/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/redis/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/nginx/" class="nav-link">nginx</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/swoole/" class="nav-link">swoole</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/live/" class="nav-link">直播入门</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/js/" class="nav-link">js</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog-src/dist/mysql/" class="nav-link router-link-exact-active router-link-active">mysql</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/elasticsearch/" class="nav-link">elasticsearch</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/redis/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/nginx/" class="nav-link">nginx</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/swoole/" class="nav-link">swoole</a></li><li class="dropdown-item"><!----> <a href="/blog-src/dist/live/" class="nav-link">直播入门</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog-src/dist/mysql/" class="active sidebar-link">mysql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-src/dist/mysql/#mysql的基础架构" class="sidebar-link">mysql的基础架构</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/mysql/#server层" class="sidebar-link">server层</a></li><li class="sidebar-sub-header"><a href="/blog-src/dist/mysql/#存储引擎层" class="sidebar-link">存储引擎层</a></li></ul></li><li><a href="/blog-src/dist/mysql/logSystem.html" class="sidebar-link">日志系统</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="mysql"><a href="#mysql" aria-hidden="true" class="header-anchor">#</a> mysql</h1> <h2 id="mysql的基础架构"><a href="#mysql的基础架构" aria-hidden="true" class="header-anchor">#</a> mysql的基础架构</h2> <p><img src="/blog-src/dist/assets/img/base.0d2070e8.png" alt="mysql基础架构图"></p> <p>mysql大体是分成：server层和存储引擎层两部分</p> <p>server层涵盖 MySQL 的大多数核心服务功能，以及所有的内置函数，所有跨存储引擎的功能都在这一层实现，
比如存储过程、触发器、视图等</p> <p>存储引擎层负责数据的存储和提取。架构模式是插件式的，支持InnoDB、MyISAM、Memory等多个存储引擎.</p> <p>不同的存储引擎共用一个Server层.</p> <h2 id="server层"><a href="#server层" aria-hidden="true" class="header-anchor">#</a> server层</h2> <p>server层主要提供跨存储引擎的功能，包括</p> <ol><li>连接器</li> <li>查询缓存</li> <li>分析器</li> <li>优化器</li> <li>执行器</li></ol> <h3 id="连接器"><a href="#连接器" aria-hidden="true" class="header-anchor">#</a> 连接器</h3> <p>执行sql之前首先要和数据库服务器建立连接：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># $ip mysql服务器ip </span>
<span class="token comment"># $port mysql服务器端口号（默认值端口是3306）</span>
<span class="token comment"># $user 登录mysql服务器的用户名</span>
mysql -h<span class="token variable">$ip</span> -P<span class="token variable">$port</span> -u<span class="token variable">$user</span> -p
</code></pre></div><p>通过TCP连接后，连接器会进行身份认证(之前mysql客户端输入的用户名和密码)</p> <ol><li>如果用户名或者密码不对，会收到&quot;Access denied for user&quot;的错误，结束客户端的执行</li> <li>如果用户名和密码验证通过，连接器会在权限表里面查出该用户拥有的权限，之后权限判断的逻辑都是依赖于此时获取的逻辑。意味着，之后对此用户有过权限的修改，都不影响此次连接（除非断开了，再重新连接）。</li></ol> <p>连接完成后，没有后续动作，这个连接就会处于空闲状态，可以使用命令：show processlist;查看当前的连接列表
空闲状态的连接太长时间（默认值是8小时）会自动断开，可以通过命令：show variables like 'wait_timeout'查看具体值</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 查看连接列表</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> processlist<span class="token punctuation">;</span>
<span class="token comment"># 查看空闲连接自动断开的时间值</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'wait_timeout'</span>
</code></pre></div><h4 id="数据库的长连接和短连接"><a href="#数据库的长连接和短连接" aria-hidden="true" class="header-anchor">#</a> 数据库的长连接和短连接</h4> <p>长连接：建立连接后，客户端持续有请求，一直使用同一个连接</p> <p>短连接：执行完很少的查询就断开连接，后面有查询再重新建立连接</p> <p>建立连接的过程比较复杂，使用中尽量减少建立连接的操作，即尽量使用长连接</p> <p>但是全部使用长连接后，有些时候内存占用涨的特别快，这是因为MySQL在执行过程中临时使用的内存是管理在连接对象里面的。这些内存占用需要等链接断开才会释放。对于这个问题,可以考虑以下两种方案</p> <ol><li>定期断开长连接。使用一段时间，或者程序判断执行过一个占用内存大的查询后，断开连接，之后查询再进行重连</li> <li>如果MySql版本大于等于5.7，可以在每次执行一个比较大的操作后, 通过执行mysql_reset_connection来重新初始化连接资源。这个过程不需要重新连接和重新做权限验证，但是会将连接恢复到刚刚创建连接时的状态。</li></ol> <h3 id="查询缓存"><a href="#查询缓存" aria-hidden="true" class="header-anchor">#</a> 查询缓存</h3> <p>建立连接之后，就可以执行SQL语句了。Mysql拿到一个查询请求，会先到查询缓存看看之前是否有执行过这条语句。之前执行的语句可能会以key-value对的形式直接缓存在内存中，key是查询的语句，value是查询的结果。如果语句不在查询缓存中，就会进行后面的阶段。执行完成后，执行结果会被存入查询缓存中。</p> <p>但是大多数情况下建议不要使用查询缓存。</p> <p>查询缓存的失效非常频繁，只要有对一个表的更新，这个表的所有的查询缓存都会被清空。对于更新压力大的数据库来说，查询缓存命中率非常低，除非是一张静态表。</p> <p>Mysql提供了按需使用的方式，可以将数据库参数query_cache_type设置成DEMAND，默认不实用查询缓存，需要使用查询缓存的可以这样写sql，Mysql8.0版本将查询缓存整块功能删除掉了，之后的版本都都没有这个功能了。</p> <div class="language-sql extra-class"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> SQL_CACHE <span class="token operator">*</span> <span class="token keyword">from</span> T <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="分析器"><a href="#分析器" aria-hidden="true" class="header-anchor">#</a> 分析器</h3> <p>没有命中查询缓存，就会执行到分析器这边。分析器先会做词法分析，再进行语法分析。语法分析会检测是否存在语法错误。</p> <p>如果语法有误，会收到&quot;You have an error in your SQL syntax&quot;的错误提醒，一般语法错误会出现在第一个出现错误的位置，提示中use near后面接着的就是语法出错的位置。</p> <h3 id="优化器"><a href="#优化器" aria-hidden="true" class="header-anchor">#</a> 优化器</h3> <p>优化器会在表中有多个索引的时候决定使用那个索引，或者在一个语句有多表关联的的时候，决定各个表的连接顺序。</p> <h3 id="执行器"><a href="#执行器" aria-hidden="true" class="header-anchor">#</a> 执行器</h3> <p>开始执行语句之前，会先判断对查询的表是否有执行查询的权限，如果没权限，会返回没有权限的错误。</p> <p>如果有权限，会打开表继续执行，执行器会根据表的引擎定义，去使用这个引擎提供的接口查询数据</p> <hr> <h2 id="存储引擎层"><a href="#存储引擎层" aria-hidden="true" class="header-anchor">#</a> 存储引擎层</h2> <p>这里负责数据的查询和存储。提供接口给server层使用</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/blog-src/dist/mysql/logSystem.html">
          日志系统
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/blog-src/dist/assets/js/6.deed1cda.js" defer></script><script src="/blog-src/dist/assets/js/app.2dbcb048.js" defer></script>
  </body>
</html>
