(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{161:function(t,s,a){t.exports=a.p+"assets/img/swoole.fe7d24b5.jpg"},162:function(t,s,a){t.exports=a.p+"assets/img/process1.73588dc2.png"},163:function(t,s,a){t.exports=a.p+"assets/img/process.bd822ec4.jpg"},186:function(t,s,a){"use strict";a.r(s);var n=[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"server详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server详解","aria-hidden":"true"}},[this._v("#")]),this._v(" Server详解")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"启动server流程图"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#启动server流程图","aria-hidden":"true"}},[this._v("#")]),this._v(" 启动server流程图")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("下图是官方的启动server的流程图\n"),s("img",{attrs:{src:a(161),alt:"server启动流程图"}}),this._v("\n之前的入门篇介绍了创建一个http-server和websocket-server，这两种server都是继承自"),s("code",[this._v("swoole\\server")]),this._v("的，所以下面讲的同样适用swoole入门篇的server")])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("实例化server对象，需要设定绑定ip和端口号")]),this._v(" "),s("li",[this._v("设置server启动前的配置选项")]),this._v(" "),s("li",[this._v("注册不同事件回调处理函数，官方文档中支持13种事件")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"server的进程模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server的进程模型","aria-hidden":"true"}},[this._v("#")]),this._v(" Server的进程模型")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-php extra-class"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{attrs:{class:"token variable"}},[t._v("$serv")]),t._v(" "),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{attrs:{class:"token class-name"}},[t._v("Swoole"),a("span",{attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Server")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'0.0.0.0'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token number"}},[t._v("9501")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("SWOOLE_PROCESS")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("SWOOLE_SOCK_TCP")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$serv")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("on")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'start'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'master进程ID：'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("master_pid")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("PHP_EOL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'manager进程ID：'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("manager_pid")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("PHP_EOL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token function"}},[t._v("var_dump")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("setting")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$serv")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("on")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'WorkerStart'")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Swoole\\"),a("span",{attrs:{class:"token package"}},[t._v("Server")]),t._v(" "),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" int "),a("span",{attrs:{class:"token variable"}},[t._v("$worker_id")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("taskworker")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'taskWorker进程ID：'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("worker_pid")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("PHP_EOL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{attrs:{class:"token keyword"}},[t._v("echo")]),t._v(" "),a("span",{attrs:{class:"token single-quoted-string string"}},[t._v("'worker进程ID：'")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{attrs:{class:"token variable"}},[t._v("$server")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token property"}},[t._v("worker_pid")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" "),a("span",{attrs:{class:"token constant"}},[t._v("PHP_EOL")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{attrs:{class:"token variable"}},[t._v("$serv")]),a("span",{attrs:{class:"token operator"}},[t._v("-")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),a("span",{attrs:{class:"token function"}},[t._v("start")]),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("在命令行中输入"),s("code",[this._v("php server.php")]),this._v("启动server，在命令行会看到如下的打印信息")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("master进程ID：640\nmanager进程ID：641\narray"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("4"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v('"worker_num"')]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  int"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("4"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v('"task_worker_num"')]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  int"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("0"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v('"buffer_output_size"')]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  int"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("2097152"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{attrs:{class:"token string"}},[t._v('"max_connection"')]),a("span",{attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{attrs:{class:"token operator"}},[t._v("=")]),a("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  int"),a("span",{attrs:{class:"token punctuation"}},[t._v("(")]),t._v("7168"),a("span",{attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nworker进程ID：642\nworker进程ID：643\nworker进程ID：644\nworker进程ID：645\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用"),s("code",[this._v("ps aux | grep server.php")])])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("simon              656   0.0  0.0  4286452    832 s001  S+    1:19PM   0:00.00 "),a("span",{attrs:{class:"token function"}},[t._v("grep")]),t._v(" --color"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("auto --exclude-dir"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(".bzr --exclude-dir"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("CVS --exclude-dir"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(".git --exclude-dir"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(".hg --exclude-dir"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(".svn server.php\nsimon              645   0.0  0.0  4375576   3196 s002  S+    1:19PM   0:00.00 php server.php\nsimon              644   0.0  0.0  4367384   3244 s002  S+    1:19PM   0:00.00 php server.php\nsimon              643   0.0  0.0  4375576   3192 s002  S+    1:19PM   0:00.00 php server.php\nsimon              642   0.0  0.0  4375576   3196 s002  S+    1:19PM   0:00.00 php server.php\nsimon              641   0.0  0.0  4377504    620 s002  S+    1:19PM   0:00.00 php server.php\nsimon              640   0.0  0.4  4389680  30768 s002  S+    1:19PM   0:00.14 php server.php\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("使用命令"),s("code",[this._v("pstree -p 640")]),this._v("，640为之前的master进程ID，打印出如下信息")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 00001 root /sbin/launchd\n \\-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 93751 simon /Applications/iTerm.app/Contents/MacOS/iTerm2\n   \\-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 94118 simon /Applications/iTerm.app/Contents/MacOS/iTerm2 --server login -fp simon\n     \\-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 94119 root login -fp simon\n       \\-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 94120 simon -zsh\n         \\-+"),a("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v(" 00640 simon php server.php\n           \\-+- 00641 simon php server.php\n             "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("--- 00642 simon php server.php\n             "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("--- 00643 simon php server.php\n             "),a("span",{attrs:{class:"token operator"}},[t._v("|")]),t._v("--- 00644 simon php server.php\n             \\--- 00645 simon php server.php\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("可以很清楚的看到进程之间的关系，下面看一下官方给出的进程结构图\n"),s("img",{attrs:{src:a(162),alt:"进程结构图"}}),this._v("\n下图为官方给出的各种进程的主要处理的任务\n"),s("img",{attrs:{src:a(163),alt:"进程功能图"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",[s("li",[this._v("Master：是一个多线程程序")]),this._v(" "),s("li",[this._v("Manager")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("专门负责worker/task进程的fork操作和管理, manager的任务本来可以由master进程来负责，对于多线程的Master进程而言，想要多Worker进程就必须fork操作。通常，worker进程被误杀或者由于业务代码出现异常的原因会导致进程异常退出，Manager进程为了保证设计上master进程的稳定，将worker进程管理交给了manager进程")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ol",{attrs:{start:"3"}},[s("li",[this._v("worker/taskWorker：")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("ul",[s("li",[this._v("worker：主要业务逻辑都是都是在worker进程中处理")]),this._v(" "),s("li",[this._v("task：耗时任务一般都会在worker进程中将任务投递给这个进程处理")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"server启动配置项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#server启动配置项","aria-hidden":"true"}},[this._v("#")]),this._v(" server启动配置项")])}],r=a(0),e=Object(r.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),a("p",[t._v("启动server前通常需要做以下三个步骤")]),t._v(" "),t._m(3),t._v(" "),a("p",[t._v("图中$serv->start()后，会存在三种类型的进程（master，manager，worker、taskWorker），下节通过启动一个server，结合ps和pstree命令来查看启动server之后的进程结构")]),t._v(" "),t._m(4),t._v(" "),a("p",[t._v("Server存在"),a("a",{attrs:{href:"https://wiki.swoole.com/wiki/page/353.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("两种运行模式"),a("OutboundLink")],1),t._v("，单线程模式和进程模式，下面我们只介绍进程模式")]),t._v(" "),a("p",[t._v("先看如下server.php代码")]),t._v(" "),t._m(5),t._m(6),t._v(" "),t._m(7),a("p",[t._v("代码中其实没有指定任何的server配置项，但是确打印出来了4个配置项，而且其中的worker进程的数量为4")]),t._v(" "),t._m(8),t._v(" "),t._m(9),a("p",[t._v("第一行使用grep命令产生的进程可以忽略，可以看到第二列的进程ID和之前启动server时打印的进程ID一致，而且worker进程的个数为swoole扩展自己定义")]),t._v(" "),t._m(10),t._v(" "),t._m(11),t._m(12),t._v(" "),a("p",[t._v("总结：")]),t._v(" "),a("p",[t._v("swoole启动一个Server后，会存在2+N+M个进程，N表示worker进程的个数，M为taskWorker进程个数，一下就是")]),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),t._m(16),t._v(" "),t._m(17)])},n,!1,null,null,null);e.options.__file="server.md";s.default=e.exports}}]);